{% extends "layouts/base.html" %}

{% block title %} Tables {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<!-- <link rel="stylesheet" href="{{ url_for('static', filename='
home/xeon/thesis-big-softeng-data/events-to-cassandra-dockerized-system/flask-events-dashboard/apps/static/assets/css/toggling_button.css') }}"> -->
<link rel="stylesheet" href="../../static/assets/css/toggling_button.css">


{% endblock stylesheets %}

{% block content %}
<head>
  <style>
    th, td {
      text-align: center;
    }
  </style>
  <!-- Custom CSS file path relative to the static directory -->
  <!-- <link rel="stylesheet" href="{{ url_for('static', filename='/home/xeon/Thesis/flask-material-dashboard/apps/static/assets/css/my-custom-css.css') }}"> -->

 

  <!-- Change all months based on UI selection -->
  <script>
    function listen_to_selected_day(){
      document.getElementById("day_dropdown_list_selection").addEventListener(
      "change", function() {
        const month_from_ui = this.value; 
        let month_placeholders_elements =  document.getElementsByClassName("day_selection")
        for (var month_placeholders_index = 0; 
          month_placeholders_index < month_placeholders_elements.length;
          month_placeholders_index++){
            month_placeholders_elements[month_placeholders_index].textContent = month_from_ui
        }
      }
      )
    }
  </script>


  <!-- Create ranking table -->
  <script>
    function create_ranking_table_html_body(element_id_to_assign_hmtl_onto, 
      data_url, html_head, second_col, third_col
    ) {
        /*
      Creates the table contents (html_body)
      - second_col: column name of the fetched JSON table to represent 
      as the second column in the ui table
      - third_col: column name of the fetched JSON table to represent 
      as the third column in the ui table
      
      - returns the html combining the head and the body of the table
      */

      var html_body_inside = `<tbody>`

      //  Create the html_body of the table
      fetch(data_url)
        .then(response => response.json())
        .then(data => {
          // const pull_requests = data[0][0].total_pull_requests;
          
          var top_contributors_list = data["top_contributors"]
          for (let data_index = 0; data_index < top_contributors_list.length; data_index++){
            html_body_inside = html_body_inside 
              + `<tr>`
              + `<td>${data_index+1}</td>`
              + `<td>${top_contributors_list[data_index][second_col]}</td>`
              + `<td>${top_contributors_list[data_index][third_col]}</td>`
              + `</tr>`
          }
          html_body_inside = html_body_inside + `</tbody>`;
          
          document.getElementById(element_id_to_assign_hmtl_onto).innerHTML = 
          html_head + html_body_inside;    

        }
      );
    }
  </script>

  <!-- Create top human contributors table -->
  <script>
    function update_top_human_contributors_table(day_selected){
      // Arguments to create the table
      var table_html_id = "top_human_contributors_table"
      var html_head = `<thead class="text-warning">
        <tr>
          <th>Place</th>
          <th>Username</th>
          <th>Number of commits</th>
        </tr>
      </thead>`
      var second_column_name = 'username'
      var third_column_name = 'number_of_contributions'

      // Get the data URL 
      let data_url = 'http://localhost:3200/bots_vs_humans/top_contributing_humans_bot_like_committers_removed/' + day_selected;
      // Create the table
      create_ranking_table_html_body(table_html_id, data_url, html_head, 
        second_column_name, third_column_name);
    }
    // update_top_human_contributors_table()
  </script>

  <!-- Create top human contributors table -->
  <script>
    function update_top_bot_contributors_table(day_selected){
      // Arguments to create the table
      var table_html_id = "top_bot_contributors_table"
      var html_head = `<thead class="text-warning">
        <tr>
          <th>Place</th>
          <th>Bot name</th>
          <th>Number of commits</th>
        </tr>
      </thead>`
      var second_column_name = 'username'
      var third_column_name = 'number_of_contributions'

      // Get the data URL 
      
      let data_url = 'http://localhost:3200/bots_vs_humans/top_contributing_bots/' + day_selected;
      // Create the table
      create_ranking_table_html_body(table_html_id, data_url, html_head, 
        second_column_name, third_column_name);
       
    }
  </script>

  <!-- Update pull-requests made by humans -->
  <script>
    function update_pull_requests_by_humans(day_selected){
      data_url = 'http://localhost:3200/bots_vs_humans/pull_requests_by_humans/' + day_selected;
      //  Create the html_body of the table
      fetch(data_url)
        .then(response => response.json())
        .then(data => {          
          
          number_of_accepted_pull_requests = data["number_of_accepted_pull_requests"];
          number_of_rejected_pull_requests = data["number_of_rejected_pull_requests"];
          
          // Percentage
          merge_rate = number_of_accepted_pull_requests
            /(number_of_accepted_pull_requests + number_of_rejected_pull_requests)*100;
          
          merge_rate_two_decimals = merge_rate.toFixed(2)
          merge_rate_stringified = merge_rate_two_decimals.toString() + '%';

          // Print number of accepted pull-requests and corresponding rate 
          // if there are accepted pull requests (not null valued) 
          if (number_of_accepted_pull_requests != null){
            document.getElementById("number-of-accepted-pull-requests-by-humans").textContent = number_of_accepted_pull_requests;
            document.getElementById("pull-request-merge-success-by-humans").textContent = 
              merge_rate_stringified;
          }
          

        }
      );
      
    };
  </script>

  <!-- Update pull-requests made by bots -->
  <script>
    function update_pull_requests_by_bots(day_selected){
      data_url = 'http://localhost:3200/bots_vs_humans/pull_requests_by_bots/' + day_selected;
      //  Create the html_body of the table
      fetch(data_url)
        .then(response => response.json())
        .then(data => {          
          
          number_of_accepted_pull_requests = data["number_of_accepted_pull_requests"];
          number_of_rejected_pull_requests = data["number_of_rejected_pull_requests"];
          
          // Percentage
          merge_rate = number_of_accepted_pull_requests
            /(number_of_accepted_pull_requests + number_of_rejected_pull_requests)*100;
          // 
          merge_rate_two_decimals = merge_rate.toFixed(2)
          merge_rate_stringified = merge_rate_two_decimals.toString() + '%';

          // Print number of accepted pull-requests and corresponding rate 
          // if there are accepted pull requests (not null valued) 
          if (number_of_accepted_pull_requests != null){
            document.getElementById("number-of-accepted-pull-requests-by-bots").          textContent = number_of_accepted_pull_requests;
            document.getElementById("pull-request-merge-success-by-bots").textContent = 
              merge_rate_stringified;
          }
          
        }
      );
      
    };
  </script>

  <!-- Update number of events made by humans and bots -->
  <script>
    function update_number_of_events_by_humans_and_bots(day_selected){
      data_url = 'http://localhost:3200/bots_vs_humans/number_of_events_by_humans_and_bots/' 
        + day_selected;
      
      //  Create the html_body of the table
      fetch(data_url)
        .then(response => response.json())
        .then(data => {          
          
          // Print total number of human events, bot events and corresponding percentage of human and bot events among total number of events
          total_number_of_events_by_humans = data["humans"]["total_number_of_events"];
          total_number_of_events_by_bots = data["bots"]["total_number_of_events"];

          human_events_percentage = total_number_of_events_by_humans
            /(total_number_of_events_by_humans + total_number_of_events_by_bots)*100;
          human_events_percentage_two_decimals = human_events_percentage.toFixed(2)
          human_events_percentage_stringified = 
            human_events_percentage_two_decimals.toString() + '%';
          
          bot_events_percentage = total_number_of_events_by_bots
            /(total_number_of_events_by_humans + total_number_of_events_by_bots)*100;
          bot_events_percentage_two_decimals = bot_events_percentage.toFixed(2);
          bot_events_percentage_stringified = 
            bot_events_percentage_two_decimals.toString() + '%';
          

          if (total_number_of_events_by_humans != 0){
            document.getElementById("number-of-events-by-humans").textContent = 
              total_number_of_events_by_humans;
              document.getElementById("human-events-percentage").textContent = 
            human_events_percentage_stringified;
          }

          if (total_number_of_events_by_bots != 0){
            document.getElementById("number-of-events-by-bots").textContent = 
            total_number_of_events_by_bots;
            document.getElementById("bot-events-percentage").textContent = 
            bot_events_percentage_stringified;
          }
          
          
        }
      );
      
    };
  </script>

<!-- TODO: Add functions for the events, also change the ids of the respective HTML elements -->




</head>




<!-- <body> -->
  
  <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur" navbar-scroll="true">
    <div class="container-fluid py-1 px-3">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
          <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Github Analyzer</a></li>
          <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Bots vs humans</li>
        </ol>
        <h6 class="font-weight-bolder mb-0">Bots vs humans</h6>
      </nav>
      <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
    </div>
  </nav>

  
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}{% endblock javascripts %}

<!-- Stacked bar graph kept for reference -->
<!-- Bar chart instead of pie chart for the Github events
            <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
              <div class="bg-gradient-dark shadow-dark border-radius-lg py-3 pe-1">
                <div id="percentage_of_events_horizontal_stacked_bar_graph" style="height: 400px;"></div>
              </div>
            </div>
            <script>

              function updateNumberOfGithubEventsChart(day_selected) {
                
                var options = {
                  title: {
                    text: 'Github events',
                    align: 'center',
                    margin: 50,
                    style: {
                      fontSize: '25px',
                      fontWeight: 'bold',
                      fontFamily: undefined,
                      color: '#ffffff'
                    },
                  },
                  legend: {
                    position: 'top',
                    horizontalAlign: 'center',
                    offsetX: 40,
                    fontSize: '20px',

                    labels: {
                      colors: ["#ffffff", "#ffffff"],
                    },

                    itemMargin: {
                      horizontal: 40,
                      vertical: 0
                    },
                  },
                  series: [{
                    name: 'Created by humans',
                    data: [22410]
                  },
                  {
                    name: 'Created by bots',
                    data: [77590]
                  }],
                  dataLabels: {
                    enabled: true,
                    style: {
                      fontSize: '20px'
                    },
                    // The formatter has the percentage of number of events (for humans or bots) as input and not the number of events because the chart is a 100% chart meaning it automatically calculates the rates from the numbers
                    formatter: function (numberOfEventsRate) {
                        return numberOfEventsRate.toFixed(2) + '%';
                    }
                  },
                  chart: {
                    type: 'bar',
                    height: 400,
                    stacked: true,
                    stackType: '100%'
                  },
                  plotOptions: {
                    bar: {
                      horizontal: true,
                    },
                  },
                  stroke: {
                    width: 1,
                    colors: ['#ffffff']
                  },

                  xaxis: {
                    categories: [""],
                    title: {
                      text: 'Total number of events: ?',
                      style: {
                        fontSize: '20px',
                        fontFamily: undefined,
                        fontWeight: 200,
                        color: '#ffffff'
                      },
                      margin: 20,
                      offsetX: 10,
                      offsetY: 10,
                    },
                    labels: {
                      style: {
                        colors: ['#ffffff', '#ffffff', '#ffffff', '#ffffff'],
                        fontSize: '14px',
                        fontFamily: 'Helvetica, Arial, sans-serif',
                        fontWeight: 400,
                        cssClass: 'apexcharts-xaxis-label',
                      }
                    }

                  },

                  tooltip: {
                    y: {
                      formatter: function (numberOfEvents) {
                        return numberOfEvents;
                      }
                    }
                  },
                  fill: {
                    opacity: 1

                  },

                };

                var chart = new ApexCharts(document.querySelector("#percentage_of_events_horizontal_stacked_bar_graph"), options);
                chart.render();

                const numberOfEventsUrl = 'http://localhost:3200/bots_vs_humans/number_of_events_by_humans_and_bots/' + day_selected;
                fetch(numberOfEventsUrl)
                  .then(response => response.json())
                  .then(data => {
                    const total_number_of_events_by_humans = data["humans"]["total_number_of_events"];
                    const total_number_of_events_by_bots = data["bots"]["total_number_of_events"];
                    const fetchedNumberOfEvents = {
                      series: [{
                          name: 'Created by humans',
                          data: [total_number_of_events_by_humans]
                        },
                        {
                          name: 'Created by bots',
                          data: [total_number_of_events_by_bots]
                        }],
                        xaxis: {
                          title: {
                            text: 'Total number of events: ' + (total_number_of_events_by_humans + total_number_of_events_by_bots),
                          }

                        }
                      };
                    chart.updateOptions(fetchedNumberOfEvents);
                  }) 
              }
              

            </script>
            -->

</body>